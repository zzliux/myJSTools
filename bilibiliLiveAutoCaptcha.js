var ocr = {
	canvas: null,
	ctx: null,
	img: null,
	imgData: null,
	redChannel: null,
	expresstion: null,
	init: function(){
		this.canvas = document.createElement("canvas");
		this.ctx = this.canvas.getContext('2d');
	},
	loadImage: function(arg){
		if(typeof arg === 'string'){
			this.img = document.createElement('img');
			this.img.setAttribute('src', arg);
		}else{
			this.img = arg;
		}
		this.canvas.setAttribute('width', 120);
		this.canvas.setAttribute('height', 40);
		this.ctx.drawImage(this.img, 0, 0, 120, 40);
		this.imgData = this.ctx.getImageData(0, 0, 120, 40);

		this.redChannel = [];
		var tmpOutPut = '';
		for(var i=0; i<40; i++){
			this.redChannel.push([]);
			for(var j=0; j<120; j++){
				this.redChannel[i].push([]);
				this.redChannel[i][j] = this.imgData.data[120*4*i + 4*j];
				tmpOutPut += this.redChannel[i][j]<220?'■':'□';
			}
			tmpOutPut += '\n';
		}
		console.log(tmpOutPut);
	},
	test: function(){
		var std = {
			'0': '0111111111111110111111111111111111111111111111111111111111111111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111111111111111111111111111111111111111111111111111111111111111',
			'1': '0011111001111101111110111111011111101111111111111111111111111110011111001111100111110011111001111100111110011111001111100111110011111001111100111110011111001111100111110011111001111100111110011111001111100111110011111',
			'2': '0111111111111110111111111111111111111111111111111111111111111111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111000000000011111100000000001111110000000001111110000000001111111000000000111111000000000111111000000000011111100000000011111100000000011111100000000001111110000000001111110000000000111110000000000111111000000000111111000000000011111000000000011111100000000001111100000000001111111111111111111111111111111111111111111111111111111111111111',
			'3': '0111111111111110111111111111111111111111111111111111111111111111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111000000000011111100000000011111110000000111111110000000111111110000000011111100000000001111111100000000011111111000000000011111110000000000111111000000000001111100000000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111111111111111111111111111111111111111111111110111111111111110',
			'4': '00000001111110000000000011111100000000001111110000000000011111100000000000111110000000000011111100000000000111111000000000001111100000000000111111000000000001111110000000000011111000000000001111110000000000011111101111100000111110011111000011111100111110000111111001111100001111100011111000111111000111110001111110001111100011111000011111001111110000111110011111111111111111111111111111111111111111111111111111111111111111111000000000011111000000000000111110000000000001111100000000000011111000000000000111110000000000001111100',
			'5': '1111111111111111111111111111111111111111111111111111111111111111111110000000000011111000000000001111100000000000111110000000000011111000000000001111100000000000111110000000000011111111111111101111111111111111111111111111111111111111111111110000000000011111000000000001111100000000000111110000000000011111000000000001111100000000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111111111111111111111111111111111111111111111110111111111111110',
			'6': '0111111111111110111111111111111111111111111111111111111111111111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000000000111110000000000011111000000000001111100000000000111111111111111011111111111111111111111111111111111111111111111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111111111111111111111111111111111111111111111110111111111111110',
			'7': '1111111111111111111111111111111111111111111111111111111111111111111110000011111111111000001111111111100000111110111110000011111000000000011111100000000001111110000000000111110000000000011111000000000011111100000000001111110000000000111110000000000011111000000000011111100000000001111110000000000111111000000000011111000000000011111100000000001111110000000000111111000000000011111000000000011111100000000001111110000000000111111000000000011111000000000011111100000000001111110000000000111110000000',
			'8': '0111111111111110111111111111111111111111111111111111111111111111111110000001111111111000000111111111100000011111111110000001111111111100000111111111100000011111111110000001111111111100001111110111111111111110001111111111110000011111111110000011111111111100011111111111111011111110011111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111111111111111111111111111111111111111111111110111111111111111',
			'9': '1111111111111110111111111111111111111111111111111111111111111111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111100000011111111110000001111111111111111111111111111111111111111111111111111101111111111111110000000000011111000000000001111100000000000111110000000000011111111110000001111111111000000111111111100000011111111110000001111111111000000111111111111111111111111111111111111111111111111111110111111111111110',
			'+': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111110000000000001111100000000000011111000000000000111110000000000001111100000000000011111000000111111111111111111111111111111111111111111111111111111111111111111110000001111100000000000011111000000000000111110000000000001111100000000000011111000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
			'-': '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
		};
		var vis = [];
		for(var i=0; i<this.redChannel[0].length; i++){
			vis.push(false);
		}
		for(var i=0; i<this.redChannel.length; i++){
			for(var j=0; j<this.redChannel[i].length; j++){
				if(this.redChannel[i][j] < 220){
					vis[j] = true;
				}
			}
		}
		var result = '';
		for(var i=0; i<vis.length; i++)if(vis[i]){
			var L, R;
			L = R = i;
			while(vis[R]) R++;
			var str = '';
			for(var j=4; j<=34; j++){
				for(var k=L; k<R; k++){
					str += this.redChannel[j][k]<220 ? '1' : '0';
				}
			}
			var min = 0xFFFFFF, minKey = 0;
			for(var key in std){
				var t = editDistance(str, std[key]);
				if(min > t){
					min = t;
					minKey = key;
				}
			}
			result += minKey;
			i = R;
		}
		this.expresstion = result;
		return eval(result);
	}
};
function editDistance(s1, s2){
	var v0 = [], v1 = [];
	v0.push(0);
	v1.push(0);
	for(var i=0; i<s2.length; i++){
		v0.push(i+1);
		v1.push(0);
	}
	for(var i=1; i<=s1.length; i++){
		v1[0] = i;
		for(var j=1; j<=s2.length; j++){
			var cost = s1[i-1] === s2[j-1] ? 0 : 1;
			v1[j] = min(v1[j-1]+1, v0[j]+1, v0[j-1]+cost);
		}
		for(var j=0; j<v1.length; j++){
			v0[j] = v1[j];
		}
	}
	return v0[s2.length];
	function min(a, b, c){
		var t = a;
		if(t > b) t = b;
		if(t > c) t = c;
		return t;
	}
}
function autoCaptcha(){
	ocr.init();
	ocr.loadImage(document.getElementsByClassName('captcha-img v-top')[0]);
	var res = ocr.test();
	document.getElementsByClassName('live-input material')[0].value = res;
	console.log('[计算]' + ocr.expresstion + '=' + res);
}
!function(){
	// autoCaptcha();
	var bt = document.createElement('button');
	document.getElementsByClassName('box-panel live-popup-panel dp-none acquire')[0].append(bt);
	bt.innerHTML = '自动计算';
	bt.style = 'position:absolute;bottom:15px;left:15px;';
	bt.setAttribute('class', 'live-btn default')
	bt.addEventListener('click', function(){
		autoCaptcha();
	});
}()
